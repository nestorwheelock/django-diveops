name: Create Superuser

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Superuser username'
        required: true
        default: 'admin'
      email:
        description: 'Superuser email'
        required: true
      password:
        description: 'Superuser password'
        required: true

jobs:
  create-superuser:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Create superuser on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/diveops

            # Create superuser using Django shell
            docker compose -f docker-compose.prod.yml exec -T web python manage.py shell << 'PYEOF'
            from django.contrib.auth import get_user_model
            User = get_user_model()
            username = "${{ github.event.inputs.username }}"
            email = "${{ github.event.inputs.email }}"
            password = "${{ github.event.inputs.password }}"
            if User.objects.filter(username=username).exists():
                print(f"User {username} already exists, updating password")
                user = User.objects.get(username=username)
                user.set_password(password)
                user.save()
            else:
                User.objects.create_superuser(username=username, email=email, password=password)
                print(f"Superuser {username} created successfully")
            PYEOF

            echo "Done! You can now log in at https://happydiving.mx/admin/"
