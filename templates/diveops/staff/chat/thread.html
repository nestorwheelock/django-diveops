{% extends "portal_ui/base.html" %}
{% load static %}

{% block title %}{{ person.first_name }} - Chat{% endblock %}

{% block extra_css %}
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="{% static 'diveops/chat/manifest.json' %}">
<style>
    html, body { height: 100%; overflow: hidden; }
    .chat-app { height: 100vh; height: 100dvh; display: flex; flex-direction: column; }
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .messages-container { scroll-behavior: smooth; }
    .message-bubble { max-width: 85%; word-wrap: break-word; }
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .message-new { animation: slideIn 0.2s ease-out; }
</style>
{% endblock %}

{% block body %}
<div class="chat-app bg-gray-100" x-data="chatThread()">
    <!-- Header -->
    <header class="bg-blue-600 text-white safe-top shadow-lg flex-shrink-0">
        <div class="flex items-center gap-3 px-4 py-3">
            <a href="{% url 'diveops:chat-inbox' %}" class="p-1 hover:bg-blue-700 rounded-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>

            <div class="flex-1 min-w-0">
                <h1 class="font-semibold truncate">{{ person.first_name }} {{ person.last_name }}</h1>
                <p class="text-xs text-blue-200 truncate">{{ person.email }}</p>
            </div>

            <a href="{% url 'diveops:lead-detail' person.pk %}"
               class="p-2 hover:bg-blue-700 rounded-lg"
               title="View Lead Details">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
            </a>
        </div>

        <!-- Quick Info Bar -->
        <div class="flex items-center gap-2 px-4 pb-2 text-xs">
            <span class="px-2 py-0.5 rounded-full"
                  :class="{
                      'bg-blue-500': '{{ person.lead_status }}' === 'new',
                      'bg-yellow-500': '{{ person.lead_status }}' === 'contacted',
                      'bg-green-500': '{{ person.lead_status }}' === 'qualified',
                      'bg-purple-500': '{{ person.lead_status }}' === 'converted',
                      'bg-gray-500': !'{{ person.lead_status }}'
                  }">
                {{ person.lead_status|default:"contact" }}
            </span>
            {% if person.phone %}
            <a href="tel:{{ person.phone }}" class="flex items-center gap-1 px-2 py-0.5 bg-blue-700 rounded-full hover:bg-blue-800">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                </svg>
                Call
            </a>
            {% endif %}
            <span class="text-blue-200" x-text="connectionStatus"></span>
        </div>
    </header>

    <!-- Messages -->
    <div id="messages-container"
         class="flex-1 overflow-y-auto p-4 space-y-3 messages-container"
         @scroll="handleScroll">

        <!-- Loading -->
        <template x-if="loading">
            <div class="flex justify-center py-8">
                <svg class="animate-spin h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
            </div>
        </template>

        <!-- Empty State -->
        <template x-if="!loading && messages.length === 0">
            <div class="flex flex-col items-center justify-center h-full text-center">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                </div>
                <p class="text-gray-500 font-medium">Start the conversation</p>
                <p class="text-gray-400 text-sm">Send a message to {{ person.first_name }}</p>
            </div>
        </template>

        <!-- Messages -->
        <template x-for="(msg, index) in messages" :key="msg.id">
            <div :class="msg.direction === 'outbound' ? 'flex justify-end' : 'flex justify-start'"
                 :data-new="msg.isNew">
                <div class="message-bubble"
                     :class="[
                         msg.direction === 'outbound'
                             ? 'bg-blue-600 text-white rounded-2xl rounded-br-md'
                             : 'bg-white text-gray-900 rounded-2xl rounded-bl-md shadow-sm',
                         msg.isNew ? 'message-new' : ''
                     ]">
                    <div class="px-4 py-2">
                        <p class="whitespace-pre-wrap text-[15px]" x-text="msg.body"></p>
                        <div class="flex items-center justify-end gap-1 mt-1"
                             :class="msg.direction === 'outbound' ? 'text-blue-200' : 'text-gray-400'">
                            <span class="text-xs" x-text="msg.time"></span>
                            <template x-if="msg.direction === 'outbound' && msg.status === 'sent'">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Typing indicator placeholder -->
        <div x-show="isTyping" class="flex justify-start">
            <div class="bg-white rounded-2xl rounded-bl-md shadow-sm px-4 py-3">
                <div class="flex gap-1">
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="bg-white border-t border-gray-200 px-4 py-3 safe-bottom flex-shrink-0">
        <form @submit.prevent="sendMessage()" class="flex items-end gap-2">
            <div class="flex-1 relative">
                <textarea x-ref="input"
                          x-model="newMessage"
                          @keydown.enter.prevent="if (!$event.shiftKey) sendMessage()"
                          @input="autoResize($el)"
                          placeholder="Type a message..."
                          rows="1"
                          class="w-full px-4 py-3 bg-gray-100 rounded-2xl resize-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-colors text-[15px]"
                          style="max-height: 120px;"
                          :disabled="sending"></textarea>
            </div>
            <button type="submit"
                    :disabled="!newMessage.trim() || sending"
                    class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex-shrink-0">
                <template x-if="!sending">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </template>
                <template x-if="sending">
                    <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </template>
            </button>
        </form>
    </div>
</div>

<script>
function chatThread() {
    return {
        loading: true,
        messages: [],
        newMessage: '',
        sending: false,
        ws: null,
        connectionStatus: '',
        isTyping: false,
        personId: '{{ person.pk }}',

        init() {
            this.loadMessages();
            this.connectWebSocket();
            this.$refs.input?.focus();
        },

        async loadMessages() {
            this.loading = true;
            try {
                const resp = await fetch(`/staff/api/chat/conversations/${this.personId}/messages/`);
                if (!resp.ok) throw new Error('Failed to load');
                const data = await resp.json();
                this.messages = data.messages || [];
                this.$nextTick(() => this.scrollToBottom());
            } catch (err) {
                console.error('Failed to load messages:', err);
            } finally {
                this.loading = false;
            }
        },

        connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/chat/lead/${this.personId}/`;

            this.connectionStatus = 'Connecting...';
            this.ws = new WebSocket(wsUrl);

            this.ws.onopen = () => {
                this.connectionStatus = 'Online';
                setTimeout(() => this.connectionStatus = '', 2000);
            };

            this.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'new_message') {
                    // Avoid duplicates
                    const exists = this.messages.some(m => m.id === data.message_id);
                    if (!exists) {
                        this.messages.push({
                            id: data.message_id || 'ws-' + Date.now(),
                            body: data.body || data.message,
                            direction: data.direction || 'inbound',
                            time: this.formatTime(data.created_at),
                            isNew: true
                        });
                        this.$nextTick(() => this.scrollToBottom());
                        // Vibrate on new inbound message
                        if (data.direction === 'inbound' && navigator.vibrate) {
                            navigator.vibrate(100);
                        }
                    }
                }
            };

            this.ws.onclose = () => {
                this.connectionStatus = 'Offline';
                // Reconnect after 3 seconds
                setTimeout(() => this.connectWebSocket(), 3000);
            };

            this.ws.onerror = () => {
                this.connectionStatus = 'Connection error';
            };
        },

        async sendMessage() {
            if (!this.newMessage.trim() || this.sending) return;

            const messageText = this.newMessage.trim();
            this.newMessage = '';
            this.sending = true;

            // Reset textarea height
            if (this.$refs.input) {
                this.$refs.input.style.height = 'auto';
            }

            // Optimistic add
            const tempId = 'temp-' + Date.now();
            this.messages.push({
                id: tempId,
                body: messageText,
                direction: 'outbound',
                time: 'Sending...',
                status: 'sending',
                isNew: true
            });
            this.$nextTick(() => this.scrollToBottom());

            try {
                const resp = await fetch(`/staff/leads/${this.personId}/send-message/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: new URLSearchParams({ message: messageText })
                });

                if (resp.redirected || resp.ok) {
                    // Update temp message
                    const msg = this.messages.find(m => m.id === tempId);
                    if (msg) {
                        msg.time = 'Just now';
                        msg.status = 'sent';
                    }
                } else {
                    throw new Error('Send failed');
                }
            } catch (err) {
                console.error('Failed to send:', err);
                // Remove failed message and restore input
                this.messages = this.messages.filter(m => m.id !== tempId);
                this.newMessage = messageText;
                alert('Failed to send message. Please try again.');
            } finally {
                this.sending = false;
                this.$refs.input?.focus();
            }
        },

        scrollToBottom() {
            const container = document.getElementById('messages-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        },

        autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        },

        formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        },

        getCsrfToken() {
            const cookie = document.cookie.split('; ').find(c => c.startsWith('csrftoken='));
            return cookie ? cookie.split('=')[1] : '';
        },

        handleScroll(e) {
            // Could implement "load more" for history here
        }
    }
}
</script>
{% endblock %}
